# 02. System Architecture – Dots and Boxes Game System

## 1. 아키텍처 개요
- 구조: 클라이언트–서버 기반 웹/모바일 앱.
- 주요 구성 요소:
  - Game Client (웹/모바일 UI, 보드 렌더링, 입력 처리)
  - Game Server (게임 룰 검증, 세션 관리)
  - Matchmaking Service (온라인 매치 옵션 시)
  - Classroom Service (교실 세션 관리)
  - Auth/Account Service (선택적 계정 관리)
  - Analytics & Logging Pipeline

## 2. 모듈 & 레이어 구성

### 2.1 클라이언트 레이어
- UI Layer: React/Flutter 등으로 구현, 보드·메뉴·대시보드 화면.
- Presentation Layer: 상태 관리(예: Redux/ Zustand / Bloc 등)와 네트워크 호출.
- Game Logic (Client-side): 입력 전 검증, 애니메이션, 오프라인 싱글 모드용 간단 룰 엔진.

### 2.2 서버 레이어
- API Layer: REST + WebSocket 엔드포인트.
- Game Engine Layer: 서버측 룰 엔진, BoardState 관리.
- Session/Match Layer: 세션 생성·종료, 플레이어 매칭, 교실 세션.
- Persistence Layer: DB 액세스, 캐시.

### 2.3 공통 서비스
- Auth/Identity, Analytics, Logging, Monitoring.

## 3. 게임 로직 스펙 요약
- 보드 모델: `BoardState` 구조 (점·변·상자, 현재 플레이어, 점수, Move 히스토리).
- 턴 엔진:
  - 유효 수 검증 → Edge 추가 → 상자 판정 → 점수/추가 턴 처리 → 게임 종료 체크.
- 체인/루프 탐지:
  - 3변 상자 그래프를 구성해 DFS/BFS로 체인 컴포넌트와 루프 식별.
- AI 인터페이스:
  - `BotStrategy.selectMove(ctx: BotContext): Edge` 형태로 플러그 가능.
- 힌트 시스템:
  - 후보 수 시뮬레이션 → 휴리스틱 점수 계산 → 상위 N개 추천.

## 4. 데이터 모델 & ERD (요약)
주요 엔티티:
- User: id, type(학생/교사/학부모/게스트), 프로필.
- GameSession: id, mode, boardSize, startedAt, endedAt, winnerId, meta.
- Move: sessionId, turnIndex, playerId, edge, createdAt.
- BoardSnapshot (선택): 특정 시점 스냅샷 저장.
- TutorialProgress: userId, stageId, status, lastPlayedAt.
- ClassSession: id, teacherId, code, createdAt, status.
- ClassParticipant: classSessionId, userId, role.
- Ranking (선택): userId, rating, season.

이 엔티티를 기준으로 RDB(예: PostgreSQL) 스키마를 설계하고, 필요 시 일부는 캐시/키밸류 스토어로 보완한다.

## 5. API 개요

### 5.1 REST API (예시)
- `POST /api/session` – 새 게임 세션 생성.
- `POST /api/session/{id}/move` – 선 긋기 요청.
- `GET /api/session/{id}` – 현재 보드 상태 조회.
- `POST /api/classroom` – 교실 세션 생성.
- `GET /api/classroom/{id}/status` – 학생별 진행 상태 조회.

### 5.2 WebSocket 이벤트 (예시)
- `game:state` – 보드 상태 브로드캐스트.
- `game:move` – 턴/선 정보 전송.
- `class:status` – 교실 모드 상태 업데이트.

## 6. 인프라 아키텍처

### 6.1 클라우드 & 네트워크
- Cloud Provider: AWS/GCP/Azure 중 선택.
- 구성:
  - VPC, Public/Private Subnet, Internet/LB, NAT.
  - CDN을 통한 정적 자산(클라이언트 번들, 이미지) 제공.

### 6.2 컴퓨트 & 런타임
- 옵션 1: Kubernetes 상의 마이크로서비스 (Game Server, API, Classroom, Auth 등).
- 옵션 2: 소규모일 경우 단일 앱 + 관리형 DB로 시작.

### 6.3 데이터베이스 & 캐시
- RDBMS: PostgreSQL.
- 캐시: Redis (세션 상태, 매치 대기열).

### 6.4 Observability & Logging
- 로그 수집: 구조화 로그 + 중앙집중 수집.
- 메트릭: 요청 수, 오류율, 지연, 동시 세션 수.
- 트레이싱: 주요 요청 경로에 분산 트레이싱 적용.

### 6.5 CI/CD 개요
- CI: 테스트·린트·빌드 자동 실행.
- CD: 스테이징 → 프로덕션 단계적 배포(블루/그린 혹은 카나리).

